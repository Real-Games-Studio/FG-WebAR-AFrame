<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Exemplo AR com A-Frame</title>
    <!-- Configuração de viewport para dispositivos móveis -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Inclusão do A-Frame (versão 1.2.0 ou superior) -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <a-scene id="scene"
             embedded
             vr-mode-ui="enabled: false"
             xr="optionalFeatures: hit-test"
             renderer="logarithmicDepthBuffer: true">
      <!-- Câmera padrão -->
      <a-camera id="camera"></a-camera>
      
      <!-- Entidade para nosso componente customizado -->
      <a-entity ar-hit-test-place></a-entity>
    </a-scene>

    <script>
      /**
       * Componente ar-hit-test-place
       *
       * - Ao iniciar a sessão AR, solicita a fonte de hit test.
       * - No método tick, utiliza renderer.xr.getFrame() para obter o XRFrame.
       * - Ao tocar na tela (click ou touchend), se houver uma pose válida,
       *   cria e posiciona um cubo de 1 metro de lado.
       */
      AFRAME.registerComponent('ar-hit-test-place', {
        init: function () {
          const sceneEl = this.el.sceneEl;
          this.hitTestSource = null;   // Fonte de hit test
          this.lastHitPose = null;     // Armazena a última pose válida

          // Ao iniciar a sessão AR, solicita a fonte de hit test
          sceneEl.renderer.xr.addEventListener('sessionstart', () => {
            const session = sceneEl.renderer.xr.getSession();
            session.requestReferenceSpace('viewer').then((refSpace) => {
              session.requestHitTestSource({ space: refSpace }).then((source) => {
                this.hitTestSource = source;
              });
            });
            // Limpa a fonte ao encerrar a sessão
            session.addEventListener('end', () => {
              this.hitTestSource = null;
            });
          });

          // Função para criar o objeto (cubo) na posição detectada
          const placeObject = () => {
            if (this.lastHitPose) {
              const pos = this.lastHitPose.transform.position;
              const box = document.createElement('a-box');
              box.setAttribute('position', { x: pos.x, y: pos.y, z: pos.z });
              box.setAttribute('width', 1);
              box.setAttribute('height', 1);
              box.setAttribute('depth', 1);
              box.setAttribute('color', '#4CC3D9');
              sceneEl.appendChild(box);
            }
          };

          // Adiciona os listeners para click e touchend
          sceneEl.addEventListener('click', placeObject);
          sceneEl.addEventListener('touchend', placeObject);
        },

        tick: function (time, delta) {
          const sceneEl = this.el.sceneEl;
          // Usa renderer.xr.getFrame() para obter o XRFrame atual
          const frame = sceneEl.renderer.xr.getFrame();
          if (!frame || !this.hitTestSource) { return; }
          
          const referenceSpace = sceneEl.renderer.xr.getReferenceSpace();
          // Executa o hit test – retorna uma lista de resultados
          const hitTestResults = frame.getHitTestResults(this.hitTestSource);
          if (hitTestResults.length > 0) {
            // Usa o primeiro resultado (geralmente o mais próximo)
            const hit = hitTestResults[0];
            const pose = hit.getPose(referenceSpace);
            if (pose) {
              this.lastHitPose = pose;
            }
          }
        }
      });
    </script>
  </body>
</html>
