<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Exemplo AR com A-Frame</title>
    <!-- Configuração de viewport para dispositivos móveis -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Inclusão do A-Frame (versão 1.2.0 ou superior) -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <!-- A cena:
         • "embedded" para ocupar a tela inteira;
         • Desativa o menu padrão de VR (não necessário para AR);
         • Atributo xr com optionalFeatures "hit-test" para habilitar a funcionalidade de detecção de superfícies.
    -->
    <a-scene id="scene"
             embedded
             vr-mode-ui="enabled: false"
             xr="optionalFeatures: hit-test"
             renderer="logarithmicDepthBuffer: true">
      <!-- A câmera padrão -->
      <a-camera id="camera"></a-camera>
      
      <!-- Uma entidade “dummy” à qual vincularemos o componente customizado que fará o hit test e posicionará o objeto -->
      <a-entity ar-hit-test-place></a-entity>
    </a-scene>

    <script>
      /**
       * Componente ar-hit-test-place
       * 
       * - Ao entrar em AR, solicita uma fonte de hit test (usando o reference space "viewer").
       * - A cada frame (tick), realiza o hit test e armazena a última pose válida.
       * - Ao tocar na tela (evento 'click'), se houver uma pose válida, cria e posiciona um cubo de 1 metro de lado.
       */
      AFRAME.registerComponent('ar-hit-test-place', {
        init: function () {
          const sceneEl = this.el.sceneEl;
          this.hitTestSource = null;   // Será preenchido com a fonte de hit test
          this.lastHitPose = null;     // Armazena a última pose detectada

          // Quando a sessão AR iniciar, solicite a fonte de hit test.
          sceneEl.renderer.xr.addEventListener('sessionstart', () => {
            const session = sceneEl.renderer.xr.getSession();
            // Solicita o reference space "viewer" para o hit test
            session.requestReferenceSpace('viewer').then((refSpace) => {
              session.requestHitTestSource({ space: refSpace }).then((source) => {
                this.hitTestSource = source;
              });
            });
            // Limpa a fonte de hit test quando a sessão terminar
            session.addEventListener('end', () => {
              this.hitTestSource = null;
            });
          });

          // Ao tocar na tela, se houver uma pose válida, cria o objeto
          sceneEl.addEventListener('click', () => {
            if (this.lastHitPose) {
              const pos = this.lastHitPose.transform.position;
              // Cria um cubo (a-box) com dimensões reais de 1 metro
              const box = document.createElement('a-box');
              box.setAttribute('position', { x: pos.x, y: pos.y, z: pos.z });
              box.setAttribute('width', 1);
              box.setAttribute('height', 1);
              box.setAttribute('depth', 1);
              box.setAttribute('color', '#4CC3D9');
              // Adiciona o cubo à cena
              sceneEl.appendChild(box);
            }
          });
        },

        tick: function (time, delta) {
          const sceneEl = this.el.sceneEl;
          // O objeto XRFrame é disponibilizado pela render loop da sessão AR.
          // Em alguns exemplos, utiliza-se sceneEl.frame; certifique-se de que o ambiente WebXR o fornece.
          const frame = sceneEl.frame;
          if (!frame || !this.hitTestSource) { return; }
          
          // Obtém o reference space atual da sessão
          const referenceSpace = sceneEl.renderer.xr.getReferenceSpace();
          // Executa o hit test – retorna uma lista de resultados
          const hitTestResults = frame.getHitTestResults(this.hitTestSource);
          if (hitTestResults.length > 0) {
            // Usa o primeiro resultado (geralmente o mais próximo)
            const hit = hitTestResults[0];
            const pose = hit.getPose(referenceSpace);
            if (pose) {
              // Armazena a pose para uso no clique/tap
              this.lastHitPose = pose;
            }
          }
        }
      });
    </script>
  </body>
</html>
